# パチンコ期待値計算ツール コード改善 実施計画

この計画では、現在のコードベース（v79.1以降）をさらに洗練させ、可読性、保守性、およびユーザー体験（UX）を向上させるための修正を行います。

## ユーザーレビューが必要な項目

- **ロジックの変数名変更**: `engine.js` 内の計算式の変数名（例: `j14Result`）をより意味のある名称に変更します。計算結果に影響はありません。
- **UI表示の微調整**: 履歴サマリーや期待値表示の演出ロジックをリファクタリングし、よりスムーズな動作を目指します。

---

## 提案される変更内容

### [共通ユーティリティ]

#### [MODIFY] [utils.js](file:///h:/gravity/pachinko-ev-calculator/js/utils.js)

- `parseCsv` のエラー耐性を向上。
- 数値フォーマット関数の共通化。

---

### [計算ロジック]

#### [MODIFY] [engine.js](file:///h:/gravity/pachinko-ev-calculator/js/engine.js)

- 難解な変数名を整理 (`j14Result` → `rawNormalEVPerBall` 等)。
- 期待値計算の各ステップを明文化するコメントの追加（特に遊タイム周辺）。
- ボーダーライン計算ロジックの関数化。

---

### [UI管理]

#### [MODIFY] [ui-manager.js](file:///h:/gravity/pachinko-ev-calculator/js/ui-manager.js)

- HTMLテンプレート文字列の生成ロジックを整理。
- サマリー更新処理のデータ計算と表示の分離。
- アラートや演出の条件分岐をより宣言的な形式にリファクタリング。

---

### [アプリケーション・コントローラー]

#### [MODIFY] [app.js](file:///h:/gravity/pachinko-ev-calculator/js/app.js)

- イベントリスナーの設定ロジックを整理し、重複を排除。
- ドロップダウンの初期化ロジックを別関数または `UIManager` へ委譲。
- `calculateEV` 関数のスリム化。

---

## 検証計画

### 動作確認項目

- 既存の計算結果（通常時・遊タイム込）が以前と一致することを確認。
- 履歴の保存、削除、復旧が正しく動作することを確認。
- LINE共有時のメッセージ内容が正しいことを確認。
- レート切り替えや統計表示のカルーセルが正しく動作することを確認。
- `force-reload-btn`（更新ボタン）によるキャッシュクリアと再ロードの確認。
