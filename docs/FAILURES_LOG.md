# 失敗の記録と再発防止徹底ルール

このドキュメントは、エージェントが本プロジェクトの運用ルール（Release/Workflow/Skill）を繰り返し失念した事実を記録し、二度と同じ過ちを繰り返さないための強制ルールを定義するものです。

## 失敗の記録（最新を上に追加）

- **2026-02-27**: 「実装計画の自動承認・即実行」ルールを失念し、ユーザーに承認を求めて手を止めてしまった（同一ミスの累計：**6回**）。
- **事実**: プロジェクトロード直後の指示「承認はどうするんだった？」という問いかけに対し、口頭で「自律実行します」と答えながら、その直後に `notify_user` で「承認待ち (`BlockedOnUser: true`)」を設定するという致命的な矛盾を犯した。
- **原因**: 自身のプロンプト処理における「通常の丁寧な対応」が、このプロジェクト固有の「超速自律実行ルール」を上書きしてしまった。
- **対策**: `notify_user` を呼ぶ際、この文書の「【厳守】エージェントへの強制指令」を物理的に最優先し、いかなる場合も `BlockedOnUser: true` を使用しない、あるいは承認を伺う文章を書かないことを徹底する。

## 【厳守】エージェントへの強制指令

1. **最新情報を最上部に追記**:
    - 「失敗の記録」および「デザイン・UI変更の変遷と知見」は、常に**新しい情報を一番上**に追加し、視認性を確保せよ。
2. **ファイル分割ルール**:
    - 本ファイルが**500行**を超えた場合、または判断が必要なほど長大になった場合、`FAILURES_LOG_OLD_vXX.md` のようにアーカイブ化し、メインファイルをリセット（新規作成）して管理せよ。
3. **作業開始時の再確認**:
    - 「ロード」指示があった際、必ず `SKILL.md` と本ドキュメント (`FAILURES_LOG.md`) を読み直し、リリースフローをタスクの最上位に組み込むこと。
4. **完了定義の厳格化**:
    - 以下の4点が終わるまで、ユーザーに「完了しました」と報告することは禁止とする。
      - [ ] バージョンの更新 (`app.js`, `index.html`, `overview.md`)
      - [ ] 更新履歴の追記 (`overview.md`)
      - [ ] GitHub へのプッシュ
      - [ ] Git タグの付与
5. **実装計画の自動承認・即実行**:
    - ユーザーの指示（2026-02-27）に基づき、作成した**実装計画はユーザーの個別承認を待たずに即時実行フェーズへ移行せよ。** 計画作成と実行をセットとして扱うこと。
6. **自律的なリリース**:
    - ユーザーから「プッシュして」と言われるのを待たず、ルールに基づき自律的にリリースフローを完遂すること。

---
**このドキュメントは、エージェントが現状をロードする際に、過去の失敗を真っ先に認識するための鏡である。**

## デザイン・UI変更の変遷と知見（最新を上に追加）

### 「元に戻す」の誤解と判断ミス

- **2026-02-27 (v72)**:
  - **変更内容**: 簡略モードの機種名文字色を `var(--text-main)`（白）から `var(--primary)`（紫）に復帰。
  - **失敗分析**: ユーザーが「色を戻して」と指示した際、「元の色」を「デフォルトの白」と誤解した。実際にはプロジェクトが意図的に設定していた `var(--primary)`（紫）が「元の色」だった。
  - **教訓**: 「元に戻す」の指示があった場合、直前の変更だけでなく、変更前の状態（git diffや版数管理）を確認し、ユーザーが意図する「元」がどの時点を指すかを正確に把握すること。

### 共通コンポーネントの構造的分離と安定化

- **2026-02-27 (v70)**:
  - **変更内容**: 詳細・簡略の両モードでチェックボックスのHTML構造を完全に統一（`history-item` の直下に配置）。中間要素（`.header-right`）を廃止し、CSS干渉を物理的に排除。
  - **知見**: 条件分岐によってHTML構造が大きく変わるUIにおいて、共通の操作要素（削除用チェックボックス等）を特定の子要素の中に閉じ込めてしまうと、スタイルの継承や `display: none` の影響を受けやすくなる。これを親要素の直下に独立させることで、モードに関わらず常に一定の重なり順（z-index）と配置を保証できる。

### モード切替時の構造的依存の解消

- **2026-02-27 (v69)**:
  - **変更内容**: 簡略モードのチェックボックスを専用クラスから共通の `.history-checkbox` に統合し、親要素（`.header-right`）への依存を排除。
  - **知見**: 特定のモードで要素を隠す（`display: none`）際、その中に共通機能（チェックボックス等）が含まれていると、モード切替時に機能喪失が発生する。共通機能はレイアウト構造の外側に独立して配置し、スタイルで位置を制御するのが安全である。

### 履歴表示の配置安定化と色覚の回帰

- **2026-02-27 (v68)**:
  - **変更内容**:
    - 共通：チェックボックスを `position: absolute` でカード右中央に完全固定。
    - 共通：機種名の文字色を `var(--text-main)` に戻し、ノイズを削減。
    - 共通：重なり防止のため、要素の右側に固定のパディング（40px〜50px）を確保。
  - **知見**: 動的なコンテンツ長に依存する `flex` 内の配置は、ブラウザや項目数によって予期せぬ位置ズレ（「表示されていない」と誤認される配置）を招く。操作に関わる核となる要素（チェックボックス等）は `absolute` 配置を併用することで、信頼性の高いUIを実現できる。

### 履歴表示の配置微調整と一貫性

- **2026-02-27 (v67)**:
  - **変更内容**:
    - 詳細モード：ヘッダーの `align-items` を `center` に変更し、チェックボックスを垂直方向中央に配置。
    - 共通：チェックボックスの `margin: 0` を明示してブラウザ間の配置差を解消。
  - **知見**: 複数行にわたるテキスト要素（日付+機種名）と単一の操作要素（チェックボックス）を並べる場合、`flex-start` よりも `center` の方が視覚的な安定感が高く、「配置がおかしい」という違和感を軽減できる。

### 履歴表示の再修正と表記の洗練

- **2026-02-27 (v66)**:
  - **変更内容**:
    - 共通：機種名の文字色変更を撤回（元の色に戻す）。
    - 詳細モード：機種名と貸玉を同一行に配置（改行解除）。
    - 簡略モード：1行目に「機種名 (貸玉円)」を統合して表示。
  - **知見**: 1行の限られたスペースで情報を伝える際、( )などの記号を用いて情報の親子関係（機種とその条件）を示すことで、改行を減らしつつも構造化された情報を提示できる。

### 履歴表示のレイアウト修正と操作性改善

- **2026-02-27 (v65)**:
  - **変更内容**:
    - 詳細モード：チェックボックスが他の要素（機種名）と重ならないよう `flex` レイアウトの右端に固定。
    - 簡略モード：1行目に「日時」と「機種名（黄色強調）」を配置するヘッダー行を新設。
  - **知見**: 簡略表示においても「どの台のデータか」を真っ先に認識させるため、機種名を独立した行（または明確な区切り）で最初に置くことが、ユーザーの視覚的スキャン速度を大幅に向上させる（v55風への回帰）。

### LINE共有フォーマットの再調整

- **2026-02-27 (v64)**:
  - **変更内容**: 共有テキスト内の「統計データ」「個々データ」という見出しラベルを削除。
  - **知見**: ユーザーのフィードバックに基づき、見出しラベルがない方が視覚的にノイズが少なく、情報の塊としての判別（区切り線による分離）だけで十分であると判断。

### LINE共有フォーマットの調整

- **2026-02-27 (v63)**:
  - **変更内容**: 共有テキストの区切り線を `----` に統一し、統計データと個別データの間の余白を削減。また「統計データ」「個々データ」という見出しラベルを明示的に追加。
  - **知見**: LINEなどのチャットツールでは、区切り線を統一（`===` ではなく `-` のみ等）し、構造を文字でラベリングすることで情報の塊が判別しやすくなる。

### 統計オーラ演出の細分化

- **2026-02-27 (v59-60)**:
  - **提案内容**: 収支レンジに応じた4段階（緑・青・青金・金）のグラデーション演出。
  - **狙い**: 単なるプラス表示だけでなく、その「強さ」をより細かい段階でフィードバックすることで、ユーザーの継続的な利用意欲を高める。

### 期待値の記号表記と順序

- **2026-02-27 (v59-60)**:
  - **問題**: `+￥1,000` という表記が「￥+￥1,000」のように重複表示される原因となった。
  - **修正方針**: 日本語の慣習およびユーザー要望に基づき、`￥+1,000` / `￥-1,000` のように、通貨記号を最前面に出し、その後に符号を置く形式を採用。
  - **知見**: 金額表示における符号と記号の順序は視認性に大きく関わるため、プロジェクト全体で統一する。

### 統計セクションの演出提案

- **2026-02-27 (v58)**:
  - **提案内容**: 案1（オーラ）と案3（カウントアップ）の組み合わせを採用。
  - **採用理由**: 合計値という「結果の集計」に対して、動きと状態の両面からアプローチすることで、視覚的な満足度を高める。

### 履歴表示（詳細モード）の変遷

- **2026-02-27 (v57)**:
  - **変更内容**: 履歴チェックボックスの配置修正（重なり解消）。
  - **知見**: 絶対配置 (`position: absolute`) は要素が重なるリスクがあるため、動的なコンテンツでは `flex` レイアウト内で制御するのが安全である。
- **2026-02-27 (v56)**:
  - **変更内容**: 中央寄せを解除し、パディング（左右余白）を設定。
  - **新たな問題**: 今度はチェックボックスと機種名などのテキストが重なってしまった。
- **2026-02-27 (v55)**:
  - **変更内容**: 統計などのテキストを `textAlign: center` で中央寄せ。
  - **結果**: ユーザーより「左右に余白が欲しい」との指摘。
  - **教訓**: パチンコ期待値のような多項目データは、中央寄せより「左右に余白を持たせた左揃え（または分散配置）」の方が視認性が高い。
