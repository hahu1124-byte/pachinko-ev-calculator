---
name: pachinko-calculator-maint
description: pachinko-ev-calculatorの更新・修正作業を円滑に行うためのメンテナンススキル
---

# pachinko-ev-calculator メンテナンススキル

このスキルは、`pachinko-ev-calculator` プロジェクトの現状を確認し、新しい機能の追加や不具合の修正、デプロイを安全に行うための手順を提供します。

## 1. 現状の把握

修正を開始する前に、必ず最新の状態を確認してください。

- **概要ドキュメントの参照**: [overview.md](file:///h:/gravity/pachinko-ev-calculator/docs/pachinko_ev_calculator_status/overview.md)
- **ワークフローの確認**: `.agent/workflows` 内の関連するワークフロー（例: `github-push.md`）を確認し、手順に従ってください。その際、`run_command` には必ず `SafeToAutoRun: true` を設定して自動実行すること。
- **ソースコード**: `app.js` (ロジック), `share.js` (LINE共有), `index.html` (UI)

## 2. 更新手順

### A. UI/スタイルの変更

1. `index.html` または `styles.css` を編集します。
2. ブラウザ（またはブラウザエージェント）を使用して、レイアウトが崩れていないか確認します。
3. ダークモードとの整合性を確認してください。

### B. 計算ロジック・共有機能の変更

1. `app.js` の `calculateEV` 関数、または `share.js` のメッセージ生成ロジックを編集します。
2. **重要な検証点**:
    - 遊タイム込の期待値が正しく算出・表示されるか。
    - 履歴保存時にデータが欠落していないか。
    - LINE共有メッセージ内の数値が最新の計算結果と一致しているか。

### C. 機種データの管理

- 機種データは以下のURLから取得されています:
    `https://docs.google.com/spreadsheets/d/e/2PACX-1vTg_z1H5K62_019noNiZnxtSTOafCW4c5y4BghW62nHmOTneMx4JzVycIXAXHTdF9vxYSOjcnu7u3BK/pub?gid=493752965&single=true&output=csv`
- CSVの列構造（`app.js` 内の `fetch` 処理）を変更する場合は、スプレッドシート側の更新と合わせる必要があります。

## 3. バージョン管理と履歴管理

### A. バージョン管理 (`v○○`)

- 更新ごとにバージョン番号をインクリメントします（例: `v39`, `v40`, ...）。
- **実施事項**:
    1. `app.js` 先頭のバージョン記述を更新する。
    2. コミットメッセージの先頭に `[v○○]` を付与する。
    3. プッシュ後にターミナルから `git tag v○○`, `git push origin v○○` を実行してタグを付与する。

### B. 履歴管理

- [overview.md](file:///h:/gravity/pachinko-ev-calculator/docs/pachinko_ev_calculator_status/overview.md) の「更新履歴」セクションにおいて、記録は最新5件までを保持します。
- それ以前の古い内容（コードや設定）に戻す必要がある場合、あるいは大規模な変更を伴う場合は、必ず事前にユーザーの再確認と承認を得る必要があります。

### C. リファクタリング時のコード整合性チェック（最重要）

- `renderHistory` などの描画ループをリファクタリングする際は、以下の「3大欠落」を絶対に起こさないよう、修正後にコードを一行ずつセルフレビューしてください。
    1. **変数の定義漏れ**: ループ内で使用する `machineCounts` や `div` 等の変数が、修正後のスコープ内で正しく定義されているか。
    2. **フィルタの欠落**: `if ((item.playRate || 4) == currentSummaryRate)` 等の、表示対象を絞る条件式が維持されているか。
    3. **DOM操作の漏れ**: `document.createElement` や `historyList.appendChild(div)` が確実に実行されているか。
- **防止策**: 可能な限り一つの `forEach` ループに処理を集約し、ロジックを分散させないことで、コピペミスや削除ミスを防ぎます。

### D. ロールバック手順

重大な不具合が発生した場合は、以下の手順で以前の安定版に戻します。

1. 現在の変更を退避または破棄する (`git reset --hard`).
2. 以前のタグに切り替える (`git checkout v○○`).
3. 必要に応じて修正を行い、新バージョンとして再度デプロイする。

### E. ファイル分割の判断

- `app.js` の役割が多岐にわたり、ファイルサイズが1000行を大きく超えてきた場合は、自律的に分割（例: `logic.js`, `ui.js`への分離）を検討・提案します。

### F. 失敗ログ・知見の管理 (v79.1〜)

- **FAILURES_LOG.md (プロジェクト内)**: 常に最新情報を最上部に追記。
- **tasks/Lessons.md (ルート)**: 失敗だけでなく「ワークフロー上の学び」として抽象化して記録。
- **履歴管理の重要性**: v66〜v73の「簡略/詳細モード逆転」のような重大な齟齬が発生した場合は、速やかに Lessons.md にパターンを記録し、再発を防止せよ。

## 5. 【最重要】再発防止・徹底事項

**過去の失敗を教訓とし、以下の事項を脳内に刻み込み、例外なく実行すること。**

- **修正 ＝ リリースまで完遂すること。**
- **CLAUDE.md の遵守**: 「上書き前の確認」や「tasks/todo.md による管理」などの **"Claude Code 連携ワークフロー"** を最優先で遵守せよ。
- **上書き前の承認義務**: 既存のファイルを編集・上書きする際は、必ず変更内容の概要を日本語で説明し、ユーザーの承認を得てから実行すること。
- **実ファイル確認の徹底**: UI修正後は `replace_file_content` の成功だけで満足せず、必ず `view_file` で実ファイルのソースが意図通り書き換わったかを確認せよ。
- **FAILURES_LOG.md の管理**: 常に最新情報を最上部に追記し、ファイルが500行を超えた場合は自律的にアーカイブ・分割を行うこと。
- **実装計画の自動承認**: 作成した実装計画は、ユーザーからの個別承認を待たずに即時実行フェーズへ移行します（2026-02-27導入ルール）。
- **【NEW】自動承認・即実行 (2026-02-28)**: `pachinko-ev-calculator` フォルダ以下の全操作において、既存ファイルの上書きを含む全ての承認を「自動承認」扱いとし、ユーザーへの個別確認をスキップして即時実行せよ。
- **コード内コメントの義務化**: 修正箇所には必ず日本語でコメントを追記し、後続が誤解しないよう詳細に記述すること。

## 6. 【最最重要】簡略/詳細モードの正しい対応関係

> [!CAUTION]
> v66〜v72で、簡略と詳細を完全に逆に理解して8バージョンに渡る連鎖障害が発生した。
> 以下の対応表を修正前に**必ず**参照すること。

### モード対応表

| ボタン表示 | 現在のモード | コード上の値 | 表示形式 | 機種名の色 |
| ---------- | ------------ | ------------- | ------------------------------------- | ----------------------- |
| 「詳細」 | **簡略モード** | `isCompact=false` | 展開表示（回転率/持比/期待値の3項目） | **紫** `var(--primary)` |
| 「簡略」 | **詳細モード** | `isCompact=true` | compact表示（全データ1行詰め込み） | **白** `var(--text-main)` |

### 必須チェック

1. **ボタンテキスト = 切り替え先**。ユーザーが言うモード名はボタンテキストの**逆**。
2. `isCompact=true`（compact表示、全データ1行）= ユーザーの言う **「詳細」**。変数名で判断しない。
3. `isCompact=false`（展開表示、主要3項目）= ユーザーの言う **「簡略」**。
4. 「色を戻す」等の指示があった場合、**必ず `git diff` で変更前の状態を確認してから作業する**。
5. **コード内コメントの確認**: プッシュ前に、追加したコメントが処理内容と一致しており、第三者が読んでも分かりやすいか再確認する。

## 7. スプレッドシート対応とGitHub連携 (v79.1〜)

計算ロジック（特に `engine.js`）を修正・改善する際は、スプレッドシートの数式との整合性を保つため、以下のルールを厳守すること。

- **対応表の参照**: 修正前に必ず [variable_mapping.md](file:///h:/gravity/pachinko-ev-calculator/docs/code_brush_up/variable_mapping.md) を参照し、どの変数がスプレッドシートのどのセル（J14, I18等）に対応しているかを確認せよ。
- **コメントの維持**: `engine.js` 内の計算式付近にある `[スプレッドシート X 相当]` というコメントは、変数名を変更した場合でも必ず残し、常に最新の対応関係を示すようにせよ。
- **GitHubへの自動反映**: Claudeによるコード変更・更新が完了した後は、**必ず `.agent/workflows/github-push.md` を実行して、最新の変更をGitHubへプッシュすること**。これを一連の作業の標準工程（定義済みのワークフロー）とする。
